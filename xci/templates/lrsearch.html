{% extends "base.html" %}
{% block content %}
<div class="row">
	<div class="col-md-12">
		<form class="form-horizontal" role="form" id="searchform">
			{{ search_form.hidden_tag() }}
			{% for field in search_form %}
			<div class="form-group">
			{{ field.label(class_='sr-only', for=field.id) }}
			{{ field(class_='form-control', placeholder=field.name) }}
			</div>
			{% endfor %}
			<button type="submit" class="btn btn-default">Search</button>
		</form>
	</div>
</div>
<br/>
<div class="row" style="display:none" id="resultsrow">
	<div class="col-md-6">
		<div id="countdiv">There were <b id="count"></b> results</div>
		<ul class="media-list" id="resultslist">
		</ul>
		<ul class="pager" id="resultPager">
			<li id="resultPreviousLi" class="previous"><a id="resultPreviousA" href="#">&larr; Previous</a></li>
			<li id="resultNextLi" class="next"><a id="resultNextA" href="#">Next &rarr;</a></li>
		</ul>
	</div>
	<div class="col-md-6">
		<br>
		<div id="compContainer">
			<!--If user is admin they'll have the teacher role as well-->
			{% if 'teacher' in current_user.roles %}
			<div id="userComps">
			<!--Javascript fills this in-->
			</div>
			<ul class="pager" id="compPager">
				<li id="compPreviousLi" class="previous"><a id="compPreviousA" href="#">&larr; Previous</a></li>
				<li id="compNextLi" class="next"><a id="compNextA" href="#">Next &rarr;</a></li>
			</ul>
			{% else %}
			Must be a teacher or admin to link LR results to competencies!
			{% endif %}
		</div>
	</div>
</div>
{% endblock %}
{% block js %}
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
<script type="text/javascript">
	//Start of everything automatically ran once page loads
	/*
	Safe root to use
	Initialize resultPages and resultCurrentPage
	Set LR_SERVER to retrieve LR data
	Get comps from local server
	*/
	var SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
	var LR_SERVER = "http://72.243.185.28/";
	var resultPages = 0;
	var resultCurrentPage = 0;
	var comps = JSON.parse("{{ comps }}".replace(/u&#39;|&#39;/g, "\""));

	// If there are no comps hide the pager
	if (comps.length === 0){
		$('#userComps').append("There are no competencies in the system!");
		$('#compPager').hide();
	}
	else{
		/*
		Set the comp limit per page
		Get all of the comp keys into a list and get length
		Initialize compPages and compCurrentPage
		*/
		var COMP_PAGE_LIMIT = 25;
		var compTotal = comps.length;
		var compPages = 0;
		var compCurrentPage = 0;
		
		// If user has more comps that can fit on one page - calculate how many pages needed
		if (compTotal > COMP_PAGE_LIMIT){
			compPages = (compTotal % COMP_PAGE_LIMIT == 0) ? compTotal / COMP_PAGE_LIMIT : Math.floor(compTotal / COMP_PAGE_LIMIT);
		}

		// Create large array that will hold arrays of comp ids for each page
		var bigArray = new Array();
		for(i=0; i<=compPages*COMP_PAGE_LIMIT; i+=COMP_PAGE_LIMIT){
			try{
				// Push array of 5 comp keys into big array
				bigArray.push(comps.slice(i, (i + COMP_PAGE_LIMIT)));
			}
			catch(err){
				// This happens at the end of comp list, just push the remaining comp keys
				bigArray.push(comps.slice(i, (compTotal - 1)));
			}
		}
		// Add the first comp list to the DOM
		addComps(bigArray[0])

		// If there is more than one page of comps - set the href for the compNext link and hide the compPrevious button
		// Else hide the comp next/prev buttons
		if (compPages > 0){
			$('#compNextA').attr('href', compCurrentPage + 1)
			$('#compPreviousLi').hide()
		}
		else{
			$('#compNextLi').hide()
			$('#compPreviousLi').hide()
		}
	}
	//End of everything automatically ran after page loads

	function processData(data){
		// Add screenshot to each item
		$.each(data['data'], function(index, value){
			value['screenshot'] = LR_SERVER + "screenshot/" + value['_id'];
		});
		return data
	}
	function addToResultsList(data){
		// Add result HTML to the resultslist
		// Add draggable to item (won't bind correctly after document ready)
		$.each(data['data'], function(index, value){
			$('#resultslist').append("<li class='media draggable' id='"+value['_id']+"'>"
									+ "<a class='pull-left' href='"+value['url']+"' target='_blank'>"
									+ "<img class='media-object' src='"+value['screenshot']+"' alt='"+value['title']+"' height='180px' width='171px'>"
									+ "</a>"
									+ "<div class='media-body'>"
									+ "<h4 class='media-heading'>"
									+ "<a href='"+value['url']+"' target='_blank'>"+value['title']+"</a></h4>"
									+ value['description']+"</div></li>");
			$('#resultslist li').last()
				.draggable({
					helper: "clone",
					revert: "invalid",
					stop: function(){
						$(this).draggable('option', 'revert', 'invalid');
					},
					zIndex: 10
				});			
		});
	}
	function addComps(array){
		// Clear userComps div
		$('#userComps').html("")

		// For each comp in the array - add that data to the DOM and add droppable functionality
		$.each(array, function(index, value){
			$('#userComps').append("<div class='panel panel-default droppable' id='"+value.id+"' style='height:180px'>"
									+ "<div class='panel-heading'>"
									+ "<h3 class='panel-title'><a href='"+SCRIPT_ROOT+"competencies?uri="+value.uri+"'>"+value.title+"</a></h3>"
									+ "</div>"
									+ "<div class='panel-body'>"
									+ "<p>"+value.description+"</p></div>");
			$('#userComps div').last()
				.droppable({
					hoverClass: "ui-state-hover",
					drop: function(event, ui){
						var postData = {'lr_uri': $(ui.draggable).find('a').attr('href'), 'c_id': value.id};
						$.post(SCRIPT_ROOT+"link_lr_data", postData, function(data, status){
							alert(data);
						});
					}
				});
		});
	}

	$('#searchform').submit(function(event){
		/*
		Prevent fire
		Clear any previous results
		Hide previous button
		Get keyword and make query
		*/
		event.preventDefault();
		$('#resultslist').html("");
		$('#resultPreviousLi').hide();
		$('#resultNextLi').show();
		var keyword = $('input[name=search]', this).val();
		var query = "search?terms=" + keyword;
		var url = LR_SERVER + query;		
		var pageQuery = "&page=";

		$.getJSON(url, function(data){
			data = processData(data)
			
			// Set compTotal count and calculate pages
			num = data['count']
			$('#count').html(num);
			resultPages = (num % 25 == 0) ? num / 25 : Math.floor(num / 25)

			// Set query for next/prev buttons
			if (resultPages > 1){
				$('#resultNextLi').attr('href', url + pageQuery + (resultCurrentPage + 1))
				$('#resultPreviousA').attr('href', url + pageQuery + (resultCurrentPage - 1))
			}
			else{
				$('#resultNextLi').hide()
				$('#resultPreviousLi').hide()
			}

			// Display the whole row
			addToResultsList(data)
			$('#resultsrow').show();
			$('input[name=search]', this).val('')
		});
	});
	$('#resultNextLi').click(function(event){
		/*
		Prevent fire
		Clear any previous results
		Increment current page
		*/
		event.preventDefault();	
		$('#resultslist').html("");
		resultCurrentPage++;

		// Get href for next button
		var href = $('#resultNextLi').attr('href');
		$.getJSON(href, function(data){
			data = processData(data)

			// Make sure prev button is shown and decrement it
			// If current page is at the end - hide next button
			// Else - increment next button
			$('#resultPreviousLi').show()
			$('#resultPreviousA').attr('href', href.substr(0, href.length - 1) + (resultCurrentPage - 1))
			if (resultCurrentPage == resultPages){
				$('#resultNextLi').hide()
			}
			else{
				$('#resultNextLi').attr('href', href.substr(0, href.length - 1) + (resultCurrentPage + 1))
			}

			// Display the whole row
			addToResultsList(data)
			$('#resultsrow').show();
		});		
	});
	$('#resultPreviousA').click(function(event){
		/*
		Prevent fire
		Clear any previous results
		Decrement current page
		*/
		event.preventDefault();
		$('#resultslist').html("");
		resultCurrentPage--;

		// Get href for prev button
		var href = $('#resultPreviousA').attr('href')
		$.getJSON(href, function(data){
			data = processData(data)

			// Make sure next button is shown and increment it
			// If current page is first page - hide prev button
			// Else - decrement prev button
			$('#resultNextLi').show()
			$('#resultNextLi').attr('href', href.substr(0, href.length - 1) + (resultCurrentPage + 1))
			if (resultCurrentPage == 0){
				$('#resultPreviousLi').hide()
			}
			else{
				$('#resultPreviousA').attr('href', href.substr(0, href.length - 1) + (resultCurrentPage - 1))				
			}	
			
			// Display the whole row
			addToResultsList(data)
			$('#resultsrow').show();
		});		
	});
	$('#compNextA').click(function(event){
		/*
		Prevent fire
		Add new page of comps to div
		Increment comp page
		*/
		event.preventDefault();
		addComps(bigArray[$('#compNextA').attr('href')])
		compCurrentPage++

		// Decrement previous link and show previous button
		$('#compPreviousA').attr('href', compCurrentPage - 1)
		$('#compPreviousLi').show()

		// If compCurrentPage equals total comp pages hide next button
		// Else increment page for next link
		if (compCurrentPage == compPages){
			$('#compNextLi').hide()
		}
		else{
			$('#compNextA').attr('href', compCurrentPage + 1)
		}
	});
	$('#compPreviousA').click(function(event){
		/*
		Prevent fire
		Add new page ofcomps to div
		Decrement comp page
		*/
		event.preventDefault();		
		addComps(bigArray[$('#compPreviousA').attr('href')])
		compCurrentPage--

		// Increment next link and show next button
		$('#compNextA').attr('href', compCurrentPage + 1)
		$('#compNextLi').show()

		// If compCurrentPage equals 0 hide previous button
		// Else decrement page for previous link
		if (compCurrentPage == 0){
			$('#compPreviousLi').hide()
		}
		else{
			$('#compPreviousA').attr('href', compCurrentPage - 1)
		}
	});
</script>
{% endblock %}