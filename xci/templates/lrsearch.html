{% extends "base.html" %}
{% block content %}
<div class="row">
	<div class="col-md-12">
		<form class="form-horizontal" role="form" id="searchform">
			{{ search_form.hidden_tag() }}
			{% for field in search_form %}
			<div class="form-group">
			{{ field.label(class_='sr-only', for=field.id) }}
			{{ field(class_='form-control', placeholder=field.name) }}
			</div>
			{% endfor %}
			<button type="submit" class="btn btn-default">Search</button>
		</form>
	</div>
</div>
<div class="row" style="display:none" id="resultsrow">
	<div class="col-md-6">
		<div id="countdiv">There were <b id="count"></b> results</div>
		<ul class="media-list" id="resultslist">
		</ul>
		<ul class="pager">
			<li id="previousli" class="previous"><a id="previous" href="#">&larr; Previous</a></li>
			<li id="nextli" class="next"><a id="next" href="#">Next &rarr;</a></li>
		</ul>
	</div>
	<div class="col-md-6">
		<div id="user_comps">
		{% if current_user.is_authenticated() %}
		<!--Javascript fills this in-->
		<ul class="pager" id="comp_pager">
			<li id="cpreviousli" class="previous"><a id="previous" href="#">&larr; Previous</a></li>
			<li id="cnextli" class="next"><a id="next" href="#">Next &rarr;</a></li>
		</ul>
		{% else %}
		Must be logged in to link results!
		{% endif %}
		</div>
	</div>
</div>
{% endblock %}
{% block js %}
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
<script type="text/javascript">
	var SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
	var pages = 0
	var currentPage = 0
	var server = "http://72.243.185.28/" 

	function processData(data){
		// Add screenshot to each item
		$.each(data['data'], function(index, value){
			value['screenshot'] = server + "screenshot/" + value['_id'];
		});
		return data
	}
	function addToResultsList(data){
		// Add result HTML to the resultslist
		// Add draggable to item (won't bind correctly after document ready)
		$.each(data['data'], function(index, value){
			$('#resultslist').append("<li class='media draggable' id='"+value['_id']+"'>"
									+ "<a class='pull-left' href='"+value['url']+"' target='_blank'>"
									+ "<img class='media-object' src='"+value['screenshot']+"' alt='"+value['title']+"' height='180px' width='171px'>"
									+ "</a>"
									+ "<div class='media-body'>"
									+ "<h4 class='media-heading'>"
									+ "<a href='"+value['url']+"' target='_blank'>"+value['title']+"</a></h4>"
									+ value['description']+"</div></li>");
			$('#resultslist li').last()
				.draggable({
					helper: "clone",
					revert: "invalid",
					stop: function(){
						$(this).draggable('option', 'revert', 'invalid');
					},
					zIndex: 10
				});			
		});
	}

	$('#searchform').submit(function(event){
		/*
		Prevent fire
		Clear any previous results
		Hide previous button
		Get keyword and make query
		*/
		event.preventDefault();
		$('#resultslist').html("")
		$('#previousli').hide()
		$('#nextli').show()
		var keyword = $('input[name=search]', this).val();
		var query = "search?terms=" + keyword
		var url = server + query		
		var pageQuery = "&page="

		$.getJSON(url, function(data){
			data = processData(data)
			
			// Set total count and calculate pages
			num = data['count']
			$('#count').html(num);
			pages = (num % 25 == 0) ? num / 25 : Math.floor(num / 25)

			// Set query for next/prev buttons
			if (pages > 1){
				$('#next').attr('href', url + pageQuery + (currentPage + 1))
				$('#previous').attr('href', url + pageQuery + (currentPage - 1))
			}
			else{
				$('#nextli').hide()
				$('#previousli').hide()
			}

			// Display the whole row
			addToResultsList(data)
			$('#resultsrow').show();
			$('input[name=search]', this).val('')
		});
	});
	$('#next').click(function(event){
		/*
		Prevent fire
		Clear any previous results
		Increment current page
		*/
		event.preventDefault();	
		$('#resultslist').html("")
		currentPage = currentPage + 1

		// Get href for next button
		var href = $('#next').attr('href')
		$.getJSON(href, function(data){
			data = processData(data)

			// Make sure prev button is shown and decrement it
			// If current page is at the end - hide next button
			// Else - increment next button
			$('#previousli').show()
			$('#previous').attr('href', href.substr(0, href.length - 1) + (currentPage - 1))
			if (currentPage == pages){
				$('#nextli').hide()
			}
			else{
				$('#next').attr('href', href.substr(0, href.length - 1) + (currentPage + 1))
			}

			// Display the whole row
			addToResultsList(data)
			$('#resultsrow').show();
		});		
	});
	$('#previous').click(function(event){
		/*
		Prevent fire
		Clear any previous results
		Decrement current page
		*/
		event.preventDefault();
		$('#resultslist').html("")
		currentPage = currentPage - 1

		// Get href for prev button
		var href = $('#previous').attr('href')
		$.getJSON(href, function(data){
			data = processData(data)

			// Make sure next button is shown and increment it
			// If current page is first page - hide prev button
			// Else - decrement prev button
			$('#nextli').show()
			$('#next').attr('href', href.substr(0, href.length - 1) + (currentPage + 1))
			if (currentPage == 0){
				$('#previousli').hide()
			}
			else{
				$('#previous').attr('href', href.substr(0, href.length - 1) + (currentPage - 1))				
			}	
			
			// Display the whole row
			addToResultsList(data)
			$('#resultsrow').show();
		});		
	});

	var comps = JSON.parse("{{ comps }}".replace(/u&#39;|&#39;/g, "\""))
	if ($.isEmptyObject(comps)){
		$('#user_comps').append("You have no competencies!")
		$('#comp_pager').hide()
	}
	else{

		var total = Object.keys(comps).length;
		var cpages = (total % 25 == 0) ? total / 25 : Math.floor(total / 25)

		

		$.each(comps, function(k, v){
			$('#user_comps').append("<div class='panel panel-default droppable' id='"+k+"'>"
									+ "<div class='panel-heading>"
									+ "<h3 class='panel-title'><a href='"+SCRIPT_ROOT+'competencies'+"?uri="+v.uri+"'>"+v.title+"</a></h3>"
									+ "</div"
									+ "<div class='panel-body'>"
									+ "<p>"+v.description+"</p></div>");
			$('#user_comps div').last()
				.droppable({
					hoverClass: "ui-state-hover",
					drop: function(event, ui){
						alert("Linked LR " + $(ui.draggable).attr('id') + " to comp " + k);
					}
				});
		});

		$('#comp_pager').show()
	}
</script>
{% endblock %}